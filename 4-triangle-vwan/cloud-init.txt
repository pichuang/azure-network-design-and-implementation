#cloud-config
package_update: true
package_upgrade: true

packages:
  - iputils-ping
  - mtr
  - git
  - vim
  - dnsutils
  - python3-pip
  - ansible
  - ca-certificates
  - curl

write_files:
  - path: /tmp/install-docker.sh
    content: |
      sudo apt-get update
      sudo apt-get install ca-certificates curl
      sudo install -m 0755 -d /etc/apt/keyrings
      sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
      sudo chmod a+r /etc/apt/keyrings/docker.asc

      # Add the repository to Apt sources:
      echo \
        "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
        $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
        sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
      sudo apt-get update -y
      sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y

  - path: /home/repairman/deadman.conf
    content: |
      vm-1-private 10.11.11.4
      vm-2-private 10.22.22.4
      vm-3-private 10.33.33.4
      vm-1-public
      vm-2-public
      vm-3-public
      google 8.8.8.8
      cht 168.95.1.1

  - path: /etc/hosts
    content: |
      127.0.0.1 localhost
      10.11.11.4 vm-1 vm-southeastasia
      10.22.22.4 vm-2 vm-taiwannorth
      10.33.33.4 vm-3 vm-japaneast

  - path: /home/repairman/simple-http-server.py
    content: |
      #!/bin/bash
      sudo python3 -m http.server 80

runcmd:
  - cd /home/repairman
  - git clone https://github.com/upa/deadman
  - chown -R "repairman:repairman" /home/repairman/deadman
  - pip install --upgrade pip
  - chmod +x /tmp/install-docker.sh
  - sh /tmp/install-docker.sh
